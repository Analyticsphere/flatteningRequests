---
title: "Generate Query from Source Table Schema & Merge w/ Manaul Query"
output: html_notebook
editor_options: 
  markdown: 
    wrap: 72
---

#### 0. Load dependencies and define parameters

```{r}
library(jsonlite)
library(tools)
library(reticulate)
library(bigrquery)

# Load helper functions
source("connect_analytics_helper_functions.R")

########### DEFINE PARAMETERS ###########################
# project   <- "nih-nci-dceg-connect-dev"
# project   <- "nih-nci-dceg-connect-stg-5519"
project <- "nih-nci-dceg-connect-prod-6d04"
table   <- "Connect.module2_v2"
#########################################################

# Authenticate to BigQuery
bq_auth()

# Create temporary directory to store temp files in
if (!dir.exists("tmp")) {dir.create("tmp")}
```

#### 0.5 Get schema from BigQuery

```{r}
# Generate file names given table name
module      <- strsplit(table, split=".", fixed=TRUE)[[1]][2]
schema_json <- paste0("tmp/", module, "-schema.json")
schema_csv  <- paste0("tmp/",module, "-schema.csv")

# Pass variables to python for later use
py$schema_json <- schema_json
py$schema_csv  <- schema_csv

# Set default GCP project
set_default_gcp_project(project)

# Get the table schema from GCP as a JSON file named schema_json
get_gcp_table_schema(project, table, schema_json) 
```

```{python}
# Import python function from file
from json_schema_to_csv import json_schema_to_csv

# Generate csv file from json file
json_schema_to_csv(schema_json, schema_csv)     
```

#### 1. Generate \*-variables.csv and \*-lists.json file from source table schema.

Here, we'll generate a new query from a BigQuery table schema, given as
an excel sheet which can be exported from BigQuery. Our queries require
a query generator, a variables.csv file and a lists.json file. This
function generates filters the variables in the schema based on whether
they should be in the variables file or the list file. All variables
destined for the list file are assigned a list of CIDs that are present
in the data set for that variable, across all rows.

```{r}
# Generate the query from the schema in the form of a set of 
# variables.csv and lists.json files.
out_json <- paste0("tmp/", module,"-lists-from-schema.json")
out_csv  <- paste0("tmp/", module,"-variables-from-schema.csv")

# Get variables and lists files from schema
filter_vars_from_schema(project, table, schema_csv, out_csv, out_json, 
                               output_file_type = "json")
```

#### 2. Combine json and csv files prior to generating query

Now that we have a new query in the form of variables.csv and lists.json
files, we need to combine the new json file with the old json file.

```{r}
# -lists.json file from parent folder
old_lists_json <- paste0("../", module, "-lists.json")

# name combined json file
union_lists_json <- paste0("tmp/", module, "-lists-union.json")

# Get union of old_lists_json and out_json
union_json_str <- get_union_of_json_arrays(old_lists_json, out_json, 
                                           union_lists_json)
```

We also need to combine the variables.csv file that was generated from
the schema with the old, manually generated variables.csv file. This
code will exclude any duplicates.

```{r}
# Get union of variable files
# -lists.json file from parent folder
old_vars_csv   <- paste0("../", module, "-variables.csv")

# name combined csv file
union_vars_csv <- paste0("tmp/", module, "-vars-union.csv")

union_var_chr_array <- get_union_of_variable_csv(old_vars_csv, out_csv, 
                                                 union_vars_csv)
```

#### 3. Deal with exceptions

```{r}
# Define exceptions
exceptions <- c(178420302, 958239616, 353358909, 104430631)

# Get a list of variables with arrays containing "exception CID"
vars_w_exceptions <- get_vars_with_specified_vals(union_lists_json, 
                                                  exceptions, 
                                                  max_array_len = 2) 
vars_w_exceptions

# Remove list of variables with exceptions from the data set
new_lists_json    <- paste0("tmp/", module, "-lists-union-mod.json")
updated_variables <- remove_vars_from_json(union_lists_json, 
                                           vars_w_exceptions,
                                           output_filename = new_lists_json) 

# Add list of variables with exceptions to \*-variables\*.csv
new_vars_csv  <- paste0("tmp/", module, "-variables-union-mod.csv")

add_novel_vars_to_csv(vars_w_exceptions, union_vars_csv, 
                      out_file = new_vars_csv)
```

Get list of variables from csv file that are of type RECORD or mode
REPEATED in the schema

```{r}
#TODO This chunk needs to be tested.
vars_to_remove <- get_record_and_repeated_vars(project, table, schema_csv, 
                                              new_vars_csv)
vars_to_remove

# Remove these variables from the new csv file
if ( length(vars_to_remove ) != 0) {
  remove_vars_from_csv(new_vars_csv, vars_to_remove)
}
```

#### 4. Move modified lists.json and variables.csv files to parent directory

```{r}
# Move up-to-date files to parent directory
file.rename(new_vars_csv, old_vars_csv)
file.rename(new_lists_json, old_lists_json)
```

#### 5. Clean up intermediate files from working directory

```{r}
# Delete intermediate files from directory
unlink("tmp", recursive=TRUE)
```

#### 6. Generate query using Warren-style Query Generator

```{bash}
# Navigate to parent directory, run query generator, navigate back to 
# development directory
cd ..
node *-query_generator.js
cd development
```
